<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khatabook Style Ledger App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .customer-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .transaction-animation {
            transition: all 0.3s ease;
        }
        .print-only {
            display: none;
        }
        @media print {
            .no-print {
                display: none;
            }
            .print-only {
                display: block;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8 no-print">
            <div class="flex items-center">
                <img src="https://placehold.co/50x50" alt="Business ledger app logo with book icon" class="mr-3 rounded-lg">
                <h1 class="text-2xl font-bold text-indigo-700">Digital Bahi Khata</h1>
            </div>
            <div class="flex space-x-2">
                <button id="addCustomerBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Add Customer
                </button>
                <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Export CSV
                </button>
            </div>
        </header>

        <!-- Stats Bar -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 no-print">
            <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-500">
                <h3 class="text-gray-500 text-sm font-medium">Total Customers</h3>
                <p id="totalCustomers" class="text-2xl font-semibold">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-green-500">
                <h3 class="text-gray-500 text-sm font-medium">Total Credit</h3>
                <p id="totalCredit" class="text-2xl font-semibold">₹0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-red-500">
                <h3 class="text-gray-500 text-sm font-medium">Total Debit</h3>
                <p id="totalDebit" class="text-2xl font-semibold">₹0</p>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="mb-6 bg-white p-4 rounded-lg shadow-sm no-print">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="mb-4 md:mb-0 md:mr-4 w-full md:w-1/2">
                    <input type="text" id="searchInput" placeholder="Search customers..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex space-x-2">
                    <button id="filterAll" class="px-3 py-1 bg-indigo-600 text-white rounded-lg">All</button>
                    <button id="filterCredit" class="px-3 py-1 bg-gray-200 rounded-lg">Only Credit</button>
                    <button id="filterDebit" class="px-3 py-1 bg-gray-200 rounded-lg">Only Debit</button>
                </div>
            </div>
        </div>

        <!-- Customers List -->
        <div id="customersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Customer cards will be dynamically inserted here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-12">
            <img src="https://placehold.co/200x200" alt="Illustration of an empty notebook indicating no customer records found" class="mx-auto mb-4 rounded-lg">
            <h3 class="text-xl font-medium text-gray-700 mb-2">No customers yet</h3>
            <p class="text-gray-500 mb-4">Add your first customer to start tracking transactions</p>
            <button id="addFirstCustomer" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg">
                Add First Customer
            </button>
        </div>
    </div>

    <!-- Customer Modal -->
    <div id="customerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Add New Customer</h2>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="customerForm">
                <input type="hidden" id="customerId">
                <div class="mb-4">
                    <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1">Customer Name *</label>
                    <input type="text" id="customerName" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-4">
                    <label for="phoneNumber" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                    <input type="tel" id="phoneNumber" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-4">
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                    <textarea id="address" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelBtn" class="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-100">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save Customer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Add Transaction</h2>
                <button id="closeTransactionModalBtn" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="transactionForm">
                <input type="hidden" id="transactionCustomerId">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Transaction Type *</label>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="transactionType" value="credit" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500" checked>
                            <span class="ml-2 text-gray-700">Credit</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="transactionType" value="debit" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-2 text-gray-700">Debit</span>
                        </label>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Amount (₹) *</label>
                    <input type="number" id="amount" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <input type="text" id="description" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-4">
                    <label for="transactionDate" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <input type="date" id="transactionDate" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelTransactionBtn" class="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-100">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save Transaction</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer Detail Modal -->
    <div id="customerDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden overflow-y-auto">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 my-8">
            <div class="flex justify-between items-center mb-4">
                <h2 id="detailCustomerName" class="text-xl font-bold text-gray-800"></h2>
                <button id="closeDetailModalBtn" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="flex flex-col md:flex-row md:space-x-6 mb-6">
                <div class="md:w-1/3">
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <h3 class="font-medium text-gray-700 mb-2">Contact Info</h3>
                        <p id="detailPhone" class="text-gray-600"></p>
                        <p id="detailAddress" class="text-gray-600"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-medium text-gray-700 mb-2">Balance Summary</h3>
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-600">Total Credit:</span>
                            <span id="detailTotalCredit" class="font-medium"></span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-600">Total Debit:</span>
                            <span id="detailTotalDebit" class="font-medium"></span>
                        </div>
                        <div class="flex justify-between pt-2 border-t">
                            <span class="text-gray-600">Balance:</span>
                            <span id="detailBalance" class="font-medium text-lg"></span>
                        </div>
                    </div>
                </div>
                
                <div class="md:w-2/3">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-medium text-gray-700">Transactions</h3>
                        <button id="addTransactionToCustomerBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-lg flex items-center text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            Add Transaction
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg overflow-hidden">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Date</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Type</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Amount</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Description</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-700 no-print">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transactionTableBody" class="divide-y divide-gray-200">
                                <!-- Transactions will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-2 no-print">
                <button id="printStatementBtn" class="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-100 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
                    </svg>
                    Print Statement
                </button>
                <button id="exportCustomerCSVBtn" class="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-100 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Export CSV
                </button>
            </div>
        </div>
    </div>

    <!-- Print Template -->
    <div id="printTemplate" class="hidden print-only">
        <div class="max-w-3xl mx-auto p-6">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold">Customer Account Statement</h1>
                <p id="printCustomerName" class="text-lg font-medium"></p>
                <p id="printDateRange" class="text-gray-600"></p>
            </div>
            
            <div class="mb-6">
                <div class="flex justify-between mb-4">
                    <div>
                        <p class="text-gray-600">Phone:</p>
                        <p id="printPhone" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-gray-600">Address:</p>
                        <p id="printAddress" class="font-medium"></p>
                    </div>
                </div>
                
                <div class="flex justify-between bg-gray-100 p-3 rounded">
                    <div>
                        <p class="text-gray-600">Total Credit:</p>
                        <p id="printTotalCredit" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-gray-600">Total Debit:</p>
                        <p id="printTotalDebit" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-gray-600">Balance:</p>
                        <p id="printBalance" class="font-medium text-lg"></p>
                    </div>
                </div>
            </div>
            
            <table class="min-w-full border">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="border px-4 py-2 text-left">Date</th>
                        <th class="border px-4 py-2 text-left">Type</th>
                        <th class="border px-4 py-2 text-left">Amount</th>
                        <th class="border px-4 py-2 text-left">Description</th>
                    </tr>
                </thead>
                <tbody id="printTransactionTableBody" class="divide-y divide-gray-200">
                    <!-- Printed transactions will be inserted here -->
                </tbody>
            </table>
            
            <div class="mt-8 text-center text-sm text-gray-500">
                <p>Generated by Digital Bahi Khata App</p>
                <p>Date: <span id="printGenerationDate"></span></p>
            </div>
        </div>
    </div>

    <script>
        // Initialize data storage
        let customers = JSON.parse(localStorage.getItem('customers')) || [];
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        
        // DOM Elements
        const customersList = document.getElementById('customersList');
        const emptyState = document.getElementById('emptyState');
        const transactionModal = document.getElementById('transactionModal');
        const transactionForm = document.getElementById('transactionForm');
        const customerModal = document.getElementById('customerModal');
        const customerForm = document.getElementById('customerForm');
        const customerDetailModal = document.getElementById('customerDetailModal');
        const searchInput = document.getElementById('searchInput');
        const exportBtn = document.getElementById('exportBtn');
        
        // Stats elements
        const totalCustomersEl = document.getElementById('totalCustomers');
        const totalCreditEl = document.getElementById('totalCredit');
        const totalDebitEl = document.getElementById('totalDebit');
        
        // Event Listeners
        document.getElementById('addCustomerBtn').addEventListener('click', () => {
            openCustomerModal();
        });
        
        document.getElementById('addFirstCustomer').addEventListener('click', () => {
            openCustomerModal();
        });
        
        document.getElementById('closeModalBtn').addEventListener('click', () => {
            customerModal.classList.add('hidden');
        });
        
        document.getElementById('cancelBtn').addEventListener('click', () => {
            customerModal.classList.add('hidden');
        });
        
        document.getElementById('closeTransactionModalBtn').addEventListener('click', () => {
            transactionModal.classList.add('hidden');
        });
        
        document.getElementById('cancelTransactionBtn').addEventListener('click', () => {
            transactionModal.classList.add('hidden');
        });
        
        document.getElementById('closeDetailModalBtn').addEventListener('click', () => {
            customerDetailModal.classList.add('hidden');
        });
        
        document.getElementById('filterAll').addEventListener('click', () => {
            filterCustomers('all');
            updateActiveFilterButton('filterAll');
        });
        
        document.getElementById('filterCredit').addEventListener('click', () => {
            filterCustomers('credit');
            updateActiveFilterButton('filterCredit');
        });
        
        document.getElementById('filterDebit').addEventListener('click', () => {
            filterCustomers('debit');
            updateActiveFilterButton('filterDebit');
        });
        
        searchInput.addEventListener('input', () => {
            filterCustomers();
        });
        
        exportBtn.addEventListener('click', exportAllToCSV);
        
        customerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            saveCustomer();
        });
        
        transactionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            saveTransaction();
        });
        
        // Functions
        function updateStats() {
            // Update customer count
            totalCustomersEl.textContent = customers.length;
            
            // Calculate total credit and debit
            let totalCredit = 0;
            let totalDebit = 0;
            
            transactions.forEach(transaction => {
                if (transaction.type === 'credit') {
                    totalCredit += parseFloat(transaction.amount);
                } else {
                    totalDebit += parseFloat(transaction.amount);
                }
            });
            
            totalCreditEl.textContent = `₹${totalCredit.toLocaleString('en-IN')}`;
            totalDebitEl.textContent = `₹${totalDebit.toLocaleString('en-IN')}`;
        }
        
        function openCustomerModal(customer = null) {
            if (customer) {
                // Edit existing customer
                document.getElementById('customerId').value = customer.id;
                document.getElementById('customerName').value = customer.name;
                document.getElementById('phoneNumber').value = customer.phone || '';
                document.getElementById('address').value = customer.address || '';
                
                // Update modal title
                document.querySelector('#customerModal h2').textContent = 'Edit Customer';
            } else {
                // Add new customer
                document.getElementById('customerId').value = '';
                document.getElementById('customerName').value = '';
                document.getElementById('phoneNumber').value = '';
                document.getElementById('address').value = '';
                
                // Update modal title
                document.querySelector('#customerModal h2').textContent = 'Add New Customer';
            }
            
            customerModal.classList.remove('hidden');
        }
        
        function saveCustomer() {
            const customerId = document.getElementById('customerId').value;
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('phoneNumber').value.trim();
            const address = document.getElementById('address').value.trim();
            
            if (!name) {
                alert('Customer name is required');
                return;
            }
            
            if (customerId) {
                // Update existing customer
                const index = customers.findIndex(c => c.id === customerId);
                if (index !== -1) {
                    customers[index] = {
                        ...customers[index],
                        name,
                        phone,
                        address
                    };
                }
            } else {
                // Add new customer
                const newCustomer = {
                    id: generateId(),
                    name,
                    phone,
                    address,
                    createdAt: new Date().toISOString()
                };
                customers.push(newCustomer);
            }
            
            saveData();
            customerModal.classList.add('hidden');
            renderCustomers();
            updateStats();
        }
        
        function openTransactionModal(customerId) {
            document.getElementById('transactionCustomerId').value = customerId;
            document.getElementById('transactionDate').valueAsDate = new Date();
            
            // Clear form
            document.getElementById('amount').value = '';
            document.getElementById('description').value = '';
            
            transactionModal.classList.remove('hidden');
        }
        
        function saveTransaction() {
            const customerId = document.getElementById('transactionCustomerId').value;
            const type = document.querySelector('input[name="transactionType"]:checked').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value.trim();
            const date = document.getElementById('transactionDate').value || new Date().toISOString().split('T')[0];
            
            if (!customerId || !amount) {
                alert('Customer and amount are required');
                return;
            }
            
            const newTransaction = {
                id: generateId(),
                customerId,
                type,
                amount,
                description,
                date,
                createdAt: new Date().toISOString()
            };
            
            transactions.push(newTransaction);
            saveData();
            transactionModal.classList.add('hidden');
            
            // If detail modal is open, refresh transactions
            if (!customerDetailModal.classList.contains('hidden')) {
                renderCustomerDetail(customerId);
            }
            
            renderCustomers();
            updateStats();
        }
        
        function deleteTransaction(transactionId) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                const customerId = transactions.find(t => t.id === transactionId).customerId;
                transactions = transactions.filter(t => t.id !== transactionId);
                saveData();
                
                // If detail modal is open, refresh transactions
                if (!customerDetailModal.classList.contains('hidden')) {
                    renderCustomerDetail(customerId);
                }
                
                renderCustomers();
                updateStats();
            }
        }
        
        function renderCustomers(filter = 'all', searchTerm = '') {
            customersList.innerHTML = '';
            
            let filteredCustomers = [...customers];
            
            // Apply search filter
            if (searchTerm) {
                filteredCustomers = filteredCustomers.filter(customer => 
                    customer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (customer.phone && customer.phone.includes(searchTerm)) ||
                    (customer.address && customer.address.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            }
            
            // Apply type filter
            if (filter === 'credit') {
                filteredCustomers = filteredCustomers.filter(customer => {
                    const customerTransactions = transactions.filter(t => t.customerId === customer.id);
                    const creditSum = customerTransactions.reduce((sum, t) => t.type === 'credit' ? sum + parseFloat(t.amount) : sum, 0);
                    const debitSum = customerTransactions.reduce((sum, t) => t.type === 'debit' ? sum + parseFloat(t.amount) : sum, 0);
                    return creditSum > debitSum;
                });
            } else if (filter === 'debit') {
                filteredCustomers = filteredCustomers.filter(customer => {
                    const customerTransactions = transactions.filter(t => t.customerId === customer.id);
                    const creditSum = customerTransactions.reduce((sum, t) => t.type === 'credit' ? sum + parseFloat(t.amount) : sum, 0);
                    const debitSum = customerTransactions.reduce((sum, t) => t.type === 'debit' ? sum + parseFloat(t.amount) : sum, 0);
                    return debitSum > creditSum || (debitSum === creditSum && debitSum > 0);
                });
            }
            
            if (filteredCustomers.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                
                filteredCustomers.forEach(customer => {
                    const customerTransactions = transactions.filter(t => t.customerId === customer.id);
                    
                    // Calculate totals for this customer
                    const creditSum = customerTransactions.reduce((sum, t) => t.type === 'credit' ? sum + parseFloat(t.amount) : sum, 0);
                    const debitSum = customerTransactions.reduce((sum, t) => t.type === 'debit' ? sum + parseFloat(t.amount) : sum, 0);
                    const balance = creditSum - debitSum;
                    
                    const balanceClass = balance > 0 ? 'text-green-500' : (balance < 0 ? 'text-red-500' : 'text-gray-500');
                    const balanceText = balance > 0 ? `₹${balance.toLocaleString('en-IN')}` : 
                                         balance < 0 ? `₹${Math.abs(balance).toLocaleString('en-IN')}` : 'Settled';
                    
                    const customerCard = document.createElement('div');
                    customerCard.className = 'customer-card bg-white rounded-lg shadow-sm p-4 transition-all cursor-pointer';
                    customerCard.addEventListener('click', () => {
                        renderCustomerDetail(customer.id);
                    });
                    
                    customerCard.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-medium text-gray-800">${customer.name}</h3>
                            <span class="text-xs text-gray-500">${customerTransactions.length} txns</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-xs text-gray-500">Balance</p>
                                <p class="${balanceClass}">${balanceText}</p>
                            </div>
                            <button class="edit-customer-btn p-1 text-gray-400 hover:text-indigo-600 no-print" data-id="${customer.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                </svg>
                            </button>
                        </div>
                    `;
                    
                    customersList.appendChild(customerCard);
                });
                
                // Add event listeners to edit buttons
                document.querySelectorAll('.edit-customer-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const customerId = btn.getAttribute('data-id');
                        const customer = customers.find(c => c.id === customerId);
                        if (customer) {
                            openCustomerModal(customer);
                        }
                    });
                });
            }
            
            updateStats();
        }
        
        function renderCustomerDetail(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            // Set modal title and customer info
            document.getElementById('detailCustomerName').textContent = customer.name;
            document.getElementById('detailPhone').textContent = customer.phone || 'Not provided';
            document.getElementById('detailAddress').textContent = customer.address || 'Not provided';
            
            // Calculate customer totals
            const customerTransactions = transactions.filter(t => t.customerId === customer.id);
            const creditSum = customerTransactions.reduce((sum, t) => t.type === 'credit' ? sum + parseFloat(t.amount) : sum, 0);
            const debitSum = customerTransactions.reduce((sum, t) => t.type === 'debit' ? sum + parseFloat(t.amount) : sum, 0);
            const balance = creditSum - debitSum;
            
            // Format currency with Indian Rupees symbol
            document.getElementById('detailTotalCredit').textContent = `₹${creditSum.toLocaleString('en-IN')}`;
            document.getElementById('detailTotalDebit').textContent = `₹${debitSum.toLocaleString('en-IN')}`;
            
            const balanceEl = document.getElementById('detailBalance');
            if (balance > 0) {
                balanceEl.textContent = `You Owend ₹${balance.toLocaleString('en-IN')}`;
                balanceEl.className = 'font-medium text-lg text-green-500';
            } else if (balance < 0) {
                balanceEl.textContent = `Owend you ₹${Math.abs(balance).toLocaleString('en-IN')}`;
                balanceEl.className = 'font-medium text-lg text-red-500';
            } else {
                balanceEl.textContent = 'Settled';
                balanceEl.className = 'font-medium text-lg text-gray-500';
            }
            
            // Render transactions table
            const tableBody = document.getElementById('transactionTableBody');
            tableBody.innerHTML = '';
            
            if (customerTransactions.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="5" class="px-4 py-4 text-center text-gray-500">No transactions yet</td>`;
                tableBody.appendChild(row);
            } else {
                // Sort transactions by date (newest first)
                customerTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                customerTransactions.forEach(transaction => {
                    const row = document.createElement('tr');
                    row.className = 'transaction-animation hover:bg-gray-50';
                    
                    // Format date
                    const date = new Date(transaction.date);
                    const formattedDate = date.toLocaleDateString('en-IN', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric'
                    });
                    
                    // Format amount with ₹ symbol
                    const formattedAmount = `₹${parseFloat(transaction.amount).toLocaleString('en-IN')}`;
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-700">${formattedDate}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${
                                transaction.type === 'credit' ? 'bg-indigo-100 text-indigo-800' : 'bg-blue-100 text-blue-800'
                            }">
                                ${transaction.type === 'credit' ? 'Credit' : 'Debit'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm font-medium ${
                            transaction.type === 'credit' ? 'text-green-500' : 'text-green-500'
                        }">
                            ${transaction.type === 'credit' ? '+' : '-'}${formattedAmount}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">${transaction.description || '-'}</td>
                        <td class="px-4 py-3 text-sm no-print">
                            <button class="delete-transaction-btn text-red-500 hover:text-red-700" data-id="${transaction.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            }
            
            // Set up action buttons
            document.getElementById('addTransactionToCustomerBtn').addEventListener('click', () => {
                openTransactionModal(customer.id);
            });
            
            document.getElementById('printStatementBtn').addEventListener('click', () => {
                printCustomerStatement(customer, customerTransactions);
            });
            
            document.getElementById('exportCustomerCSVBtn').addEventListener('click', () => {
                exportCustomerToCSV(customer, customerTransactions);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-transaction-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const transactionId = btn.getAttribute('data-id');
                    deleteTransaction(transactionId);
                });
            });
            
            // Open the modal
            customerDetailModal.classList.remove('hidden');
        }
        
        function printCustomerStatement(customer, transactions) {
            // Set print content
            document.getElementById('printCustomerName').textContent = customer.name;
            document.getElementById('printPhone').textContent = customer.phone || 'Not provided';
            document.getElementById('printAddress').textContent = customer.address || 'Not provided';
            
            // Calculate totals
            const creditSum = transactions.reduce((sum, t) => t.type === 'credit' ? sum + parseFloat(t.amount) : sum, 0);
            const debitSum = transactions.reduce((sum, t) => t.type === 'debit' ? sum + parseFloat(t.amount) : sum, 0);
            const balance = creditSum - debitSum;
            
            document.getElementById('printTotalCredit').textContent = `₹${creditSum.toLocaleString('en-IN')}`;
            document.getElementById('printTotalDebit').textContent = `₹${debitSum.toLocaleString('en-IN')}`;
            
            const balanceEl = document.getElementById('printBalance');
            if (balance > 0) {
                balanceEl.textContent = `You owe ₹${balance.toLocaleString('en-IN')}`;
                balanceEl.className = 'font-medium text-lg text-red-500';
            } else if (balance < 0) {
                balanceEl.textContent = `Owes you ₹${Math.abs(balance).toLocaleString('en-IN')}`;
                balanceEl.className = 'font-medium text-lg text-green-500';
            } else {
                balanceEl.textContent = 'Settled';
                balanceEl.className = 'font-medium text-lg text-gray-500';
            }
            
            // Set date range if there are transactions
            if (transactions.length > 0) {
                const sortedDates = transactions.map(t => new Date(t.date)).sort((a, b) => a - b);
                const startDate = sortedDates[0].toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
                const endDate = sortedDates[sortedDates.length - 1].toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
                document.getElementById('printDateRange').textContent = `From ${startDate} to ${endDate}`;
            } else {
                document.getElementById('printDateRange').textContent = 'No transactions';
            }
            
            // Set generation date
            document.getElementById('printGenerationDate').textContent = new Date().toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
            
            // Populate transactions table
            const printTableBody = document.getElementById('printTransactionTableBody');
            printTableBody.innerHTML = '';
            
            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                
                // Format date
                const date = new Date(transaction.date);
                const formattedDate = date.toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
                
                // Format amount with ₹ symbol
                const formattedAmount = `₹${parseFloat(transaction.amount).toLocaleString('en-IN')}`;
                
                 row.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-700">${formattedDate}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${
                                transaction.type === 'debit' ? 'bg-indigo-100 text-indigo-800' : 'bg-blue-100 text-blue-800'
                            }">
                                ${transaction.type === 'debit' ? 'debit' : 'credit'}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm font-medium ${
                            transaction.type === 'debit' ? 'text-red-500' : 'text-red-500'
                        }">
                            ${transaction.type === 'debit' ? '+' : '-'}${formattedAmount}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">${transaction.description || '-'}</td>
                        <td class="px-4 py-3 text-sm no-print">
                            <button class="delete-transaction-btn text-red-500 hover:text-red-700" data-id="${transaction.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </td>
                    `;
                
                printTableBody.appendChild(row);
            });
            
            // Show print preview
            window.print();
        }
        
        function exportAllToCSV() {
            if (customers.length === 0) {
                alert('No customers to export');
                return;
            }
            
            // Prepare CSV header
            let csv = 'Customer Name,Phone,Address,Credit Amount,Debit Amount,Balance,Transaction Count\n';
            
            // Add customer data
            customers.forEach(customer => {
                const customerTransactions = transactions.filter(t => t.customerId === customer.id);
                const creditSum = customerTransactions.reduce((sum, t) => t.type === 'credit' ? sum + parseFloat(t.amount) : sum, 0);
                const debitSum = customerTransactions.reduce((sum, t) => t.type === 'debit' ? sum + parseFloat(t.amount) : sum, 0);
                const balance = creditSum - debitSum;
                
                // Quote fields that may contain commas
                csv += `"${customer.name}","${customer.phone || ''}","${customer.address || ''}",${creditSum},${debitSum},${balance},${customerTransactions.length}\n`;
            });
            
            // Create download link
            downloadCSV(csv, 'all_customers_export.csv');
        }
        
        function exportCustomerToCSV(customer, customerTransactions) {
            // Prepare CSV header
            let csv = 'Date,Type,Amount,Description\n';
            
            // Add transaction data
            customerTransactions.forEach(transaction => {
                csv += `"${transaction.date}","${transaction.type}","${transaction.amount}","${transaction.description || ''}"\n`;
            });
            
            // Create download link
            downloadCSV(csv, `customer_statement_${customer.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.csv`);
        }
        
        function downloadCSV(csvData, fileName) {
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            
            // Clean up
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 100);
        }
        
        function filterCustomers(type = 'all') {
            const searchTerm = searchInput.value.trim();
            renderCustomers(type, searchTerm);
        }
        
        function updateActiveFilterButton(activeId) {
            ['filterAll', 'filterCredit', 'filterDebit'].forEach(id => {
                const btn = document.getElementById(id);
                if (id === activeId) {
                    btn.classList.remove('bg-gray-200');
                    btn.classList.add('bg-indigo-600', 'text-white');
                } else {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    btn.classList.add('bg-gray-200');
                }
            });
        }
        
        function saveData() {
            localStorage.setItem('customers', JSON.stringify(customers));
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }
        
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // Initialize the app
        renderCustomers();
    </script>
</body>
</html>
